<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜í–‰í‰ê°€ ì¼ì • ì•Œë¦¬ë¯¸</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pikaday/1.8.2/css/pikaday.min.css">
    <style>
        body { font-family: Arial, sans-serif; }
        .container { width: 600px; margin: 0 auto; text-align: center; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
        .calendar-header button { background-color: #4CAF50; color: white; border: none; padding: 5px 10px; cursor: pointer; }
        .calendar { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 10px; }
        .day { width: 80px; height: 80px; border: 1px solid #ddd; margin: 5px; display: flex; align-items: center; justify-content: center; flex-direction: column; cursor: pointer; }
        .day.selected { background-color: #add8e6; }
        .schedule-list { margin-top: 20px; }
        .schedule-item { display: flex; justify-content: space-between; margin-top: 5px; }
        .schedule-item button { background-color: #ff4d4d; color: white; border: none; padding: 2px 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h2>ìˆ˜í–‰í‰ê°€ ì¼ì • ê´€ë¦¬ í˜ì´ì§€</h2>
    
    <!-- í˜„ì¬ ì›”ê³¼ ì—°ë„ í‘œì‹œ ë° ì›” ë³€ê²½ ë²„íŠ¼ -->
    <div class="calendar-header">
        <button onclick="changeMonth(-1)">&#10094; ì´ì „</button>
        <span id="currentMonthYear"></span>
        <button onclick="changeMonth(1)">ë‹¤ìŒ &#10095;</button>
    </div>

    <div id="calendar" class="calendar"></div>
    
    <!-- Pikadayë¡œ ì¼ì • ì¶”ê°€ ë‚ ì§œ ì„ íƒ -->
    <input type="text" id="datepicker" placeholder="ë‚ ì§œ ì…ë ¥">
    <input type="text" id="scheduleInput" placeholder="ì¼ì • ì œëª© ì…ë ¥">
    <button onclick="addSchedule()">ì¼ì • ì¶”ê°€í•˜ê¸°</button>

    <h3><span id="selectedDateDisplay">ì˜¤ëŠ˜</span>ì˜ ì¼ì •</h3>
    <div id="scheduleList" class="schedule-list"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pikaday/1.8.2/pikaday.min.js"></script>
<script>
    let currentDate = new Date();
    const calendar = document.getElementById('calendar');
    let selectedDate = formatDate(currentDate); // ì´ˆê¸° ì„ íƒ ë‚ ì§œ í¬ë§·ì„ YYYY-MM-DDë¡œ ì„¤ì •
    let schedules = {};

    // Pikaday ì„¤ì •
    const picker = new Pikaday({
        field: document.getElementById('datepicker'),
        format: 'YYYY-MM-DD',
        toString(date) {
            return moment(date).format('YYYY-MM-DD'); // Moment.jsë¡œ í¬ë§· ì„¤ì •
        },
        parse(dateString) {
            return moment(dateString, 'YYYY-MM-DD').toDate(); // ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ ë³€í™˜
        }
    });

    // JSON íŒŒì¼ì—ì„œ ì¼ì • ë¡œë“œ
    async function loadSchedules() {
        const response = await fetch('/api/schedules');
        if (response.ok) {
            schedules = await response.json();
            displayCalendar();
            displaySchedules();
        }
    }

    // í˜„ì¬ ì›”ê³¼ ì—°ë„ë¥¼ í‘œì‹œ
    function displayCurrentMonthYear() {
        const monthYear = currentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
        document.getElementById('currentMonthYear').textContent = monthYear;
    }

    // ìº˜ë¦°ë” í‘œì‹œ
    function displayCalendar() {
        displayCurrentMonthYear();
        calendar.innerHTML = '';
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 1; i <= firstDayOfMonth + daysInMonth; i++) {
            const dayElement = document.createElement('div');
            if (i > firstDayOfMonth) {
                const day = i - firstDayOfMonth;
                const date = new Date(year, month, day);
                const dateString = formatDate(date);
                dayElement.className = 'day' + (dateString === selectedDate ? ' selected' : '');
                dayElement.innerHTML = `<div>${day}</div>`;
                if (schedules[dateString]) {
                    dayElement.innerHTML += `<small>ğŸ“… ${schedules[dateString].length} events</small>`;
                }
                dayElement.onclick = () => selectDate(dateString);
            }
            calendar.appendChild(dayElement);
        }
    }

    // ë‚ ì§œ ì„ íƒ
    function selectDate(dateString) {
        selectedDate = dateString;
        document.getElementById('selectedDateDisplay').innerText = dateString;
        displaySchedules();
        displayCalendar();
    }

    // ì„ íƒí•œ ë‚ ì§œ ì¼ì • í‘œì‹œ
    function displaySchedules() {
        const scheduleList = document.getElementById('scheduleList');
        scheduleList.innerHTML = '';
        if (schedules[selectedDate]) {
            schedules[selectedDate].forEach((item, index) => {
                const scheduleItem = document.createElement('div');
                scheduleItem.className = 'schedule-item';
                scheduleItem.innerHTML = `${item} <button onclick="removeSchedule(${index})">Delete</button>`;
                scheduleList.appendChild(scheduleItem);
            });
        }
    }

    // ì¼ì • ì¶”ê°€
    function addSchedule() {
        const scheduleText = document.getElementById('scheduleInput').value.trim();
        const scheduleDate = picker.toString();
        
        if (scheduleDate && scheduleText) {
            if (!schedules[scheduleDate]) schedules[scheduleDate] = [];
            schedules[scheduleDate].push(scheduleText);
            document.getElementById('scheduleInput').value = '';
            if (scheduleDate === selectedDate) displaySchedules();
            displayCalendar();
            saveSchedules();
        }
    }

    // ì¼ì • ì‚­ì œ
    function removeSchedule(index) {
        schedules[selectedDate].splice(index, 1);
        if (schedules[selectedDate].length === 0) delete schedules[selectedDate];
        displayCalendar();
        displaySchedules();
        saveSchedules();
    }

    // ì¼ì • ì €ì¥
    async function saveSchedules() {
        await fetch('/api/schedules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(schedules, null, 2)
        });
    }

    // ì›” ë³€ê²½
    function changeMonth(change) {
        currentDate.setMonth(currentDate.getMonth() + change);
        displayCalendar();
    }

    // ë‚ ì§œ í¬ë§·ì„ YYYY-MM-DDë¡œ ì„¤ì •, +1 í•´ì¤Œ
    function formatDate(dateString) {
        const date = new Date(dateString);
        date.setDate(date.getDate()+1)
        return date.toISOString().split('T')[0];
    }   


    loadSchedules();
</script>

</body>
</html>
